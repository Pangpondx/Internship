#pragma once

#include <px4_platform_common/log.h>
#include <px4_platform_common/module.h>
#include <px4_platform_common/module_params.h>

#define UART_PORT "/dev/ttyS1"
#define UART_BAUDRATE B115200
#define MAX_PACKET_SIZE 512

typedef struct __attribute__((packed)) {
    uint8_t packet_id;
    uint8_t length_in_bytes;
    int16_t left_flap_cmd;
    int16_t right_flap_cmd;
    int16_t left_aileron_cmd;
    int16_t right_aileron_cmd;
    int16_t left_elevator_cmd;
    int16_t right_elevator_cmd;
    int16_t left_rudder_cmd;
    int16_t right_rudder_cmd;
    int16_t throttle_cmd;
    int16_t nose_wheel_cmd;
    uint8_t brake_cmd;
} PAYLOAD_DISCO;

typedef struct __attribute__((packed)) {
    uint8_t protocol_iden_hi;
    uint8_t protocol_iden_low;
    uint8_t protocol_version;
    uint8_t source_id : 7;
    uint8_t take_control : 1;
    uint8_t destination_id;
    uint8_t sequence;
    uint16_t length;
    uint32_t unix_time_stamp;
    uint32_t utc_microsecond_time_stamp;
    uint8_t header_check;
    PAYLOAD_DISCO user_data;
    uint16_t checksum;
} MESSAGE_HEADER;

class DiscoProtocol : public ModuleBase<DiscoProtocol>, public ModuleParams
{
public:
	DiscoProtocol();
	~DiscoProtocol() override = default;

	static DiscoProtocol *instantiate(int argc,char *argv[]);

	static int task_spawn(int argc, char *argv[]);
	static int custom_command(int argc, char *argv[]);
	static int print_usage(const char *reason = nullptr);

	void run() override;

private:

	int open_uart();
	uint8_t cal_header_check(const uint8_t* pkt);
	uint16_t GetCRC16(const void *buf, unsigned len);

	static const uint16_t crc16tab[256];
};
